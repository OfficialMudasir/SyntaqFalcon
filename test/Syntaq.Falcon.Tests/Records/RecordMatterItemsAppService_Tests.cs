using Abp.Application.Services.Dto;
using Shouldly;
using Syntaq.Falcon.Records;
using Syntaq.Falcon.Records.Dtos;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
using Xunit;

using Abp.Authorization;
using Abp.Domain.Repositories;
using Abp.Domain.Uow;
using Abp.Linq.Extensions;
using Abp.UI;
using Microsoft.AspNetCore.Authorization;
using Microsoft.AspNetCore.Cors;
using Microsoft.EntityFrameworkCore;
using Syntaq.Falcon.AccessControlList;
using Syntaq.Falcon.AccessControlList.Dtos;
using Syntaq.Falcon.Authorization;

using Syntaq.Falcon.Submissions;
using Syntaq.Falcon.Utility;

using System.IO;

using System.Linq.Dynamic.Core;

using static Syntaq.Falcon.Projects.ProjectConsts;
using static Syntaq.Falcon.Records.RecordMatterContributorConsts;
using Syntaq.Falcon.EntityFrameworkCore;

namespace Syntaq.Falcon.Tests.Records
{
    public class RecordMatterItemsAppService_Tests : AppTestBase
    {
        private readonly IRecordMatterItemsAppService _recordMatterItemsAppService;
   
          
        public RecordMatterItemsAppService_Tests( )
        {
            _recordMatterItemsAppService = Resolve<IRecordMatterItemsAppService>();
           

        }
       

        [Fact]
        public void Should_Get_All_Record_Matter_Items_By_Record_Matter()
        {
            //Arrange
            var exitingRecordMatter = UsingDbContext(context => context.RecordMatters.FirstOrDefault(a => a.RecordMatterName == "Record Matter To Update"));
            GetAllRecordMatterItemsInput input = new GetAllRecordMatterItemsInput()
            {
                Id = exitingRecordMatter.Id
            };

            //Act
            var output = _recordMatterItemsAppService.GetAllByRecordMatter(input);

            //Assert
            output.Items.Count.ShouldBe(3);
        }

        [Fact]
        public async Task Should_Get_Record_Matter_Item_For_Edit()
        {
            //Arrange
            var exitingRecordMatterItem = UsingDbContext(context => context.RecordMatterItems.FirstOrDefault(a => a.DocumentName == "Record Matter Item To Update"));

            //Act
            var output = await _recordMatterItemsAppService.GetRecordMatterItemForEdit(new EntityDto<Guid>(Guid.Parse(exitingRecordMatterItem.Id.ToString())));

            //Assert
            output.RecordMatterItem.DocumentName.ShouldBe("Record Matter Item To Update");
            output.RecordMatterItem.ShouldNotBeNull();
        }

        [Fact]
        public async Task Should_Create_Record_Matter_Item()
        {
            //Arrange
            var exitingRecordMatter = UsingDbContext(context => context.RecordMatters.FirstOrDefault(a => a.RecordMatterName == "Record Matter To Update"));
            //var exitingRecordMatterItem = UsingDbContext(context => context.RecordMatterItems.FirstOrDefault(a => a.DocumentName == "Record Matter Item To Update"));

            CreateOrEditRecordMatterItemDto recordMatterItem = new CreateOrEditRecordMatterItemDto()
            {
                Id = Guid.Parse("00000000-0000-0000-0000-000000000000"),
                DocumentName = "Unit Test Record Matter Item",
                //Document = "0x504B0304140000000800273D3252B472424BC3010000C503000010000000646F6350726F70732F6170702E786D6C9D53416EDB3010FC8AC07B4CDB288AC2A01414CE2187B6316035396FA9954D942209722DC4",
                // Document = "0x504B03041400000008004576834DB472424BC3010000C503000010000000646F6350726F70732F6170702E786D6C9D53416EDB3010FC8AC07B4CDB288AC2A01414CE2187B6316035396FA9954D942209722DC4FD5A0F7D52BFD0A59428B2DB53759A1D0E47C35DF2F7CF5FEAF6B9B3458F3119EF4AB15A2C45814EFBC6B843294ED4DE7C104522700D58EFB014674CE2B652BBE8034632980A3670A91447A2B09132E923769016BCEC78A5F5B103E2321EA46F5BA3F1CEEB53878EE47AB97C2FF199D035D8DC84C9508C8E9B9EFED7B4F13AE74B8FF539B05FA56AEC8205C2EA4BDE69178D27252752D59EC0D6A6C36AC9F454A81D1C30552B2547A09E7C6C52D68C406D8F104113372F93B34A7D0CC11A0DC44DAD3E1B1D7DF22D150F43D622EF56722E519C7F8FFA140D9DB3D5BC549F8C1B538C805345384408C7976853A5F61A2C6EF9E4550B36A1926F84BA47C833DD81C9F97ADAF4A8C9C722991F3CD5B528BE41C2DCAF52F4100D3812A36C2C066C43A258D5862C7B4FF500E7B23936EF72C8115C0AE59481F165BAE10FE9A1E5B3D13FC2AEE661870CE22D5E21AFACAFCCB6BE0BE0CE59C6FDFC9EBE86DADFE55BF0D2B24B7236E22743C77D008D57C39EF16ACF2C363CBD690013A1EE396EB4D99DF7BA0336AF9ABF17F2F5791C9F64B55A2F96FC0DF7E595E3A94FAFA5FA03504B03041400000008004576834DFD7ADCCDE20000008A01000011000000646F6350726F70732F636F72652E786D6C6D904D6AC3301085AF62B4B7C76AA114633B1768A1D04DB7429A38A2D60F9A499C9CAD8B1EA957A82C5A37852C1FEF9B0FE97D7D7CF6BBB39BAB1326B2C10F4236ADA8D0EB60AC9F0671E47DFD282A62E58D9A83C7415C90C46EEC75EC7448F89242C4C416A9CA1E4F9D8E833830C70E80F4019DA226133E97FB909CE21CD30451E9773521DCB5ED03386465142B588575DC8CE24769F4A68CC7341781D180333AF44C201B097F2C637274F3A03457A4B37C897813FD2D37FA4C760397656996FB82E6F74B787B7E7A2D5FADAD5F97D228CA3E094F765D75943D5CC792FE8F377E03504B03041400000008004576834DCA9FABA54E0300006A0F000011000000776F72642F646F63756D656E742E786D6CED57DB6E1B3710FD15761FDAA7BDE86259562D1B2E120505DAC448DCE699BB1C6989704996C3D546FEB53CE493F20B1DEE45B663341092A29083EA61A9B970E6CC707676F8E9C3C7F3CBF795625B70288D5E46A3248B18E8C208A937CBA8F6EB781E31F45C0BAE8C8665B4038C2E2FCE9B8530455D81F68C0C685C6C49567A6F17698A450915C7C458D0245C1B57714FA4DBA41577EF6A1B17A6B2DCCB5C2AE977E938CB66516FC69053A717BD89B892853368D63E6C5998F55A16D02FC30E7788DF6ECBB31E72EB3175A00883D1584A8B83B5EA6BAD91B01C8C6CBF14C4B652835E630FF1261C6FE8342AD5396A8C13D699021089FBAC13EE2D8EB20312184CEC771C02E1A1CF0149C5A5DE9BD18FCF7FEF3B21DF7DD25A537781502E2ECE7F8863F6023438EE41B07CC7AED01A84E42D2920231C2C79F9FC868D46C93CC9928CC571A8BFDC885D582D6B1654BDE2F532CAB2ABD3D35F26CFA3C077EDE3BA5B56467B24458E8594CBE84F70826B1E110738FA2B94FC01B3BCD2F850ADC07B64DAFAEF96C22802D82CB65C2DA3D52AA35FAF80B7037B326B59E91E8FBFB829C1012B39B21C4033CE28BDB9828A7144A8724569663B533B36BC6649D8EE3B23EDD37E29787B7DBCE1A73DBCEF2186FFA2CC7A0403A643D08EA78F0A2EBC9B185ECE9DF6FCAF355785D109BFAD1D3490A3F48089069FAE5A417A0395A5EE08986EC0FB9EB87CE5E4466AAE7E154B3199CCB233CEE3597E328FA767B379CC4F4F66B198F0099F038CCF26FC475ED99F874FCB942A199069E319BC977884F5FCED793EA6CAFEF7A2793A357EAD0802B0DA2AC305F554D293820DE5CBA466BE84F041A9585E4B25C025EC956308FE73D53F5EFFF613860D583869FF2FD6238C267B52C5FA106D28A637B5B5C679167A2FE3CECB42C1775166C7793001EB6AF54F689B453D70C284ABE0D171F5B32D8D6398DCD24416BA08B683ED3B6D1A05620339359F949A89270BF130B7C5434FC1B81FED40C45D57499FD4717F4B023FEF350885EFE2B09B37C114DD4246E3F1346BA1D2FF93F974B06B37BFF300C21BBA2D8DA69D0E0D22A527729EB5646EBC37D59D58C1FA9EB4044EAD7E199D66F340AE8DF1F7C84DED5BF25ED021AF687901BD52CBA7037DE1E81B41D6A5866BE98B328C85FB6A1F624A87AB497A7747BEF81B504B03041400000008004576834DE07DACCD6F0100001404000012000000776F72642F666F6E745461626C652E786D6CBD924D4EC3301085AF62794F63A73F89AAA65529EA9205700137751A4BB11D79DC869E8D0547E20A0C71828A28A895101E45F2BC791E4F3EF9EDE575B678D615394807CA9A8CF201A3449ADC6E95D96574EF8B9B9412F0C26C45658DCCE851025DCC67CDB4B0C603C1D306A62EA3A5F7F5348A202FA51630B0B534582BACD3C263EA76912D0A95CB3B9BEFB5343E8A199B444E56C2E3CD50AA1A68D7ADB9A45B63DDB67636970038AAAE423F2D94A1FD74A4991AA171E627A525907BD99007AB4530D4C258901C3D07516594C5181336646336C22FC6DD8892E8C39997C281F4BD73B5EAF44268551D7BD9B59D43A5563E2FFBC24138253695EC6AA07658D9C38665144766C9324D68507846531656A7C438585869A70C3F95D693B77DDA94AFD79DC24F3D786914707CC3F278D41B5B9DA531C6E04881B304A9C49825E769B0F8CF689CFE57A0C17FA2C17EA3917E552EA5B1C4C1CEC388D92D4218B54F24C4754F031A0570258CFF7E1ADD06E6EF504B03041400000008004576834DC09FF5E8B1020000F405000011000000776F72642F73657474696E67732E786D6C9D54DB6EDB300CFD95C0EF6DD2F4B221685AA41982166BBB60EED66745A66D21926848749CECD7F6B04FDA2F8CB6A5C5C086A1D853AC43F2F0F050CACFEF3FAE6FF7468F76E0BC423B4FCE4E27C908ACC44CD9629ED4949FBC4F469E84CD84460BF3E4003EB9BDB96E661E8838C98F98C0FA1972B6B3332F4B30C29F18251D7ACCE944A299619E2B09E12709156E9E9444D56C3C0E45A75881E5588ECE08E2A32BC67DC90794B5014BE3E964723576A005B15C5FAACA4736F3BF6C1C2C23C9EE5F43EC8C8E79CDD9E40DE336E8B2DF156F91D716540E2578CFCE1A1D052A1B69BC7E0B4F1F7A541B27DC6140D2AEED1BA21935B30A9C640B78E313DEF8B88D80D940961E3C8159A125DFA3AC07F394040157154E182378715283B0A1CED341C35A58587512564A13384EDE09167BBE9A9C85BC0C9F915E9C90DB27DC41A0CF2017B5A617B14909AB58F56E1A45595CD75652DD2DFC2338CBC6F411590AE6E256692524A34BD6EC50478AAEDB124DE5D8CD40C6BBA904B55FB58757369BAD99726B0D693BC3E75A475985C3665113E68A7A800B9EDBF17497C9933E2A4F83B9BE7878B0193BBAF0CF351BE958511C2A122C347D54D6E3B67E5416EE1C88EDA0A5D01A9B7616F894A7C2F4921E6C276FD028ADAB6EA4BE5B67CB201A34B3179E1CAF1CB2AE3EB6E8A32FB852CEF3A2F690BDAA8CCA25681D4894AFB438DC0B5BD4FA9810165D6945EBA213BEB0D99AFD7F126E3B68FF151C2DB42A6CCBF8AAA84CAB41B42B1C4863176510F8370E9E7DBFD91FDDB35E850BB016AC3FAC54F05DCF96A8EF8416567644E3E1A6A57669FB1CE04954557B799AD9A6389B27DCA124BE9ACD8CF894F11CDD61534C436CDAC5A67DAC3B08D93E19CE0E1F476C1AB141DE79C4CE8FD845C42E8ED865C42E8FD855C4AE5AAC3CF06BD5CA6EF9EDC7CF16CFB1BD3290DD1FE37F40493024FE5BDFFC02504B03041400000008004576834D2965A2AEEE040000EF2600000F000000776F72642F7374796C65732E786D6CB59ADD52DB3814805FC5E3FBADF3030961081D16DA2D3394A5249DBD566C25D6604B5E4921A4AFD68B7DA47D85957F62428EE5D531CD15B1A5F3E948D1A7184BFFFEFCE7E2E34B9A78CF542A26F8D4EF7FE8F91EE5A188185F4DFDB55EFE76E67B4A131E9144703AF5B754F91F2F2F36E74A6F13AA3C13CED5B99CFAB1D6D97910A830A629511F4446B9295B0A99126D2EE52A10CB250BE98D08D729E53A18F47AA340D28468D3B48A59A6FC8AB671A16D848C322942AA94C9354D4A5E4A18F7F3F42211DED02559275AE597F2415697D555F1E7B3E05A799B73A242C6A6FE9CA5A647F774E33D8A9470DF9450A2F49562A4B130BEE2AA392C540DB783CB8BA06A3B38CC28ABAFAA6A07F99B513263362BC7DC94D2E59D089F6834D3A660EAF7FCF2E6F7DB07C984647AFB7A6F4653F6854511E57BF578CC22FA574CF97745A3D7FBDF3E17235CDD08C59A9BCF83D1B818D244459F5E429AE5DF9729E524352DDFE701495EFBEF5D6CBFE8AAA57E4C493EB7BC3E3E649087A8BDDE148CF541573A8087C7029F1C0B7C7A2CF0E858E0F1B1C067C7024F7E353824C5F5AFC6CE994EA87BF5D97AA191115A0ABE72AFFF29CD62A298728F78484848639144547A73FAA29B8788BDAE6D93491BEE5E78B38C84AC4C7A3F0E31AC776C156B6F161793E19033EAFD7FE81D531AC43934F9876411881BB4C57DA5115BA7BB5C3D305AA321227A00A24F1CA2F3CE36347CEA1A0A5B1D3984E643D5D0EAD83514B67AE61A3A04A1AD53F286C8A7C619316E9D49D7221172B94E6CF370DC3A9FEAE8C6865BA7541DDA341BC7ADF3E98D38DE55189A0797862FC9D1203BC051253B00E5941D8392CB8E71B7CCCE68D5ED913E3365FDFD715E5C8B1C1E88242B49B2F8307678E2BEC27E5B0B4D0F0183893BE0969B876245BD46D0B0E70E7AB312D987D77D49B233DCD7263BC37D91B233DC562B6B3C6ED9B263DCD72F3BC37D21B333F02B1AFCED40AE6810805CD120A0D38A06319D56B4F73C37D819EE0F1076065E5BC8C06BFB9E670B3B03A72D88EFA62DC4E0B5850CBCB69081D7163EB721B58500A4B610D0495B88E9A42DC4E0B5850CBCB69081D71632F0DA42065EDBAEFF1B58E3BB690B31786D2103AF2D64E0B53D79AFB61080D416023A690B319DB48518BCB69081D71632F0DA42065E5BC8C06B0B19386D417C376D2106AF2D64E0B5850CBCB6A7EFD5160290DA4240276D21A693B61083D71632F0DA42065E5BC8C06B0B19786D2103A72D88EFA62DC4E0B5850CBCB69081D776F45E6D2100A92D0474D216623A690B31786D2103AF2D64E0B5850CBCB69081D7163270DA82F86EDA420C5E5BC8C06B0B19AD3335DFC54BA8B7BFD5B61FDCEFF016D5C61AF4DD59555A8F744925E5217C298B60EDF2B2C306EEB0DF8578F2EA9DD237942182C2160913C58BEF6D1ED5FA1A7D586C79376CECDAF9F33FAFBD2FB4DEE969C74F2C78D09960F3E6F848DE7A7178C7D4D4DBCC349BEDBFCD8FCA532715AAA8781BD5E73CF2E03C5753F44C92D7E31F459FAA76CB8BEA8C8DFAB1AB3AD8AD99EAC7B53AB8B9772EA66811E618C626C95053D992637560A6DE9CC88FF7808C77C76CEA5A5E51AD4AAD1EF12A2B4B369A2CCA9964C9649E97B70E99372F110DCD9A461649397AE6C32D8F4CE4A63A9253361FBD10BFAE794D93E42B29AB8BACA56E4297BA2CEEF7CE9A2A2C84D6226D21C8E277DA8E08DE2614D43DB18F245FA70B2AAB096F9D7BC506261CC86A63B3F5ABDB7D5297FF01504B03041400000008004576834D70868C44A0000000E000000014000000776F72642F77656253657474696E67732E786D6C8DCECD0DC2300C05E05522DF690A0784AAFE5CD8800942EAB6911ABB8A5D0AB37160245620120CC0D17A4FDFF3FBF9AABB7B9CCD0D9304A606F6450906C9731F686C60D561770223EAA877331336F04081AEADB76AC3EB0555734F4C3648AAD4C0A4BA54D68A9F303A297841CAD9C0293ACD671A2D0F43F07866BF4624B587B23CDA84B3D3BC2F5358047EDAF68FB671EA97C41E45F22371FE7AD1050263DB0F504B03041400000008004576834DE98BCABEE3000000B20200001C000000776F72642F5F72656C732F646F63756D656E742E786D6C2E72656C73AD92C14EC3300C865F25F29DA61B0821B46C172EBBC25EC04B9DB6224DA2D803FA6C1C78245E810889D18969E2D0A37F2B9F3F2BFE7CFF586DDE06AF5E28731F8381455583A26063D387D6C041DCD51D28160C0DFA18C8C0480C9BF5EA913C4A79C25D9F58154660039D48BAD79A6D470372151385D271310F28A5CCAD4E689FB125BDACEB5B9DA70C3865AA6D63206F9B05A8DD98E83FECE85C6FE921DAC34041CE8CD04C22652F2E4CCC2D89819FA42A2C50FABCC3724E8757DA3FFDD19884174DAEE7347131C80EF79E7E3D8ED1458B9B392D58464FD31FF9AE8FF3F5C9A1ADBF00504B03041400000008004576834D9EB5E3274B010000B7040000130000005B436F6E74656E745F54797065735D2E786D6CB5944D4EC3301046AF62798B12171608A1A65D005BA8442FE0DA93D6AA635B1EF7EF6C2C3812576092D280AAD2B4882E9399EF7BCF56948FB7F7FE705D59B68488C6BB825FE73DCEC029AF8D9B167C91CAEC8E334CD26969BD83826F00F970D01F6F0220A3ACC382CF520AF742A09A412531F7011C4D4A1F2B99E8314E45906A2EA7206E7ABD5BA1BC4BE05296EA0E3EE83F42291736B1A735BDDE7A44B0C8D9C376B166155C86608D9289E662E9F41E25FB22E4946C767066025ED10267E220A219FD4AD8055FE86AA2D1C04632A66759D19AD05E8DA20F2828901FAF3920EACBD228A08E4545911C6A230D3A0B54093119F8B63E0A573EC2F9F4DD35D5E953912B1FB56885CF46EE1DB86E23B00244FAC62A9BB7934A1AD72D52127A2C27F60F87EF3269ABBB2D1052A210FEBFC4AEF90487B4B1700983A6B79BBF82C9EBC5AEE147796B229ABFCEE013504B03041400000008004576834D103E70D1E8000000520200000B0000005F72656C732F2E72656C73AD92CB4A43410C407F65C8BE37B71544A4D36EBAE94EC41F0833B90FBCF36026D5F6DB5CF849FE8211A458A9A50B97799D1C423EDEDE97EB7D98CC0B973AA66861DEB46038BAE4C7D85BD84937BB035385A2A72945B670E00AEBD5F29127121DA9C398AB5146AC1606917C8F58DDC0816A933247AD74A904120D4B8F99DC33F58C8BB6BDC5F29301A74CB3F516CAD6CFC13C1D325FC34E5D373ADE24B70B1CE5CC8A5F1D4AA6D2B358784DC5A3FF4E378A0583E77516FFA9C37BE1E8D9CF72D1F922A39EF6E8A43A0F9AAE48395F54BAB95EE9EFEB6360214F42E852E1CB425F1D47233C7984D527504B01022D001400000008004576834DB472424BC3010000C5030000100000000000000000000000000000000000646F6350726F70732F6170702E786D6C504B01022D001400000008004576834DFD7ADCCDE20000008A0100001100000000000000000000000000F1010000646F6350726F70732F636F72652E786D6C504B01022D001400000008004576834DCA9FABA54E0300006A0F0000110000000000000000000000000002030000776F72642F646F63756D656E742E786D6C504B01022D001400000008004576834DE07DACCD6F0100001404000012000000000000000000000000007F060000776F72642F666F6E745461626C652E786D6C504B01022D001400000008004576834DC09FF5E8B1020000F405000011000000000000000000000000001E080000776F72642F73657474696E67732E786D6C504B01022D001400000008004576834D2965A2AEEE040000EF2600000F00000000000000000000000000FE0A0000776F72642F7374796C65732E786D6C504B01022D001400000008004576834D70868C44A0000000E0000000140000000000000000000000000019100000776F72642F77656253657474696E67732E786D6C504B01022D001400000008004576834DE98BCABEE3000000B20200001C00000000000000000000000000EB100000776F72642F5F72656C732F646F63756D656E742E786D6C2E72656C73504B01022D001400000008004576834D9EB5E3274B010000B70400001300000000000000000000000000081200005B436F6E74656E745F54797065735D2E786D6C504B01022D001400000008004576834D103E70D1E8000000520200000B00000000000000000000000000841300005F72656C732F2E72656C73504B0506000000000A000A007E020000951400000000",
                //Document = exitingRecordMatterItem.Document.ToString(),
                RecordMatterId = exitingRecordMatter.Id,
                Status = "Completed"
            };

            //Act
            await _recordMatterItemsAppService.CreateOrEdit(recordMatterItem);

            //Assert
            UsingDbContext(context =>
            {
                var newRecordMatterItem = context.RecordMatterItems.FirstOrDefault(a => a.DocumentName == "Unit Test Record Matter Item");
                newRecordMatterItem.ShouldNotBeNull();
            });
        }

        [Fact]
        public async Task Should_Update_Record_Matter_Item()
        {

            //Arrange
             var exitingRecordMatterItem = UsingDbContext(context => context.RecordMatterItems.FirstOrDefault(a => a.DocumentName == "Should_Update_Record_Matter_Item") );            
          

            CreateOrEditRecordMatterItemDto recordMatter = new CreateOrEditRecordMatterItemDto()
            {
                Id = Guid.Parse(exitingRecordMatterItem.Id.ToString()),
                DocumentName = "Should_Update_Record_Matter_Item Is Updated",
                RecordMatterId = exitingRecordMatterItem.RecordMatterId,
                Status = "Completed"
            };

            //Act
            await _recordMatterItemsAppService.CreateOrEdit(recordMatter);

            //Assert
            UsingDbContext(context => context.RecordMatterItems.FirstOrDefault(a => a.Id == exitingRecordMatterItem.Id)).DocumentName.ShouldBe("Should_Update_Record_Matter_Item Is Updated");
        }
    }
}
